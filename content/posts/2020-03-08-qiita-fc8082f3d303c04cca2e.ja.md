---
title: "åˆå¿ƒè€…ãŒæµã‚Œã§å­¦ã¶Docker/Kubernetesè¶…å…¥é–€"
date:  "2020-03-08T15:04:05+07:00"
author:
  - "ã•ã‚“ã½ã—"
description: "åˆå¿ƒè€…ãŒæµã‚Œã§å­¦ã¶Docker/Kubernetesè¶…å…¥é–€"
draft: false
tags: ["Elixir","Docker","kubernetes","Phoenix","docker-compose"]
categories:
  - "development"
---

## ã¯ã˜ã‚ã«
ä¸–ã¯ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢æˆ¦å›½æ™‚ä»£ã€‚Docker ãã‚‰ã„ä¸€èˆ¬å¸¸è­˜ã€‚Docker ä½¿ãˆãªã„ãªã‚“ã¦ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã‚’åä¹—ã‚Œãªã„ã€‚ãã‚“ãªæ™‚ä»£ã§ã™ã€‚ï¼ˆã»ã‚“ã¨ã‹ï¼Ÿï¼‰

ã“ã®è¨˜äº‹ã‚’æ›¸ãå§‹ã‚ãŸæ™‚ã®åƒ•ã® Docker æˆ¦é—˜åŠ›ã¯ã€Œ[Dockerå…¬å¼ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«](http://docs.docker.jp/get-started/get-started.html)ã‚’çœºã‚ãŸã ã‘ã€ã§ã™ã€‚
ãªã®ã§é€†ã«è¨€ãˆã° Docker å…¬å¼ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’ã‚„ã£ãŸã ã‘ã®æ–¹ã«ã‚‚ç†è§£ã§ãã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

ï¼ˆã¡ãªã¿ã« Kubernetes æˆ¦é—˜åŠ›ã¯ã€Œãªã‚“ã§ Kubernetes ã‚’ k8s ã£ã¦è¨€ã†ã®ã‹ã ã‘çŸ¥ã£ã¦ã‚‹ã€ã§ã™ã€‚ï¼‰

ã“ã®è¨˜äº‹ã¯ãã‚“ãªåƒ•ãŒ**ã€ŒDocker/Kubernetes ã¡ã‚‡ã£ã¨åˆ†ã‹ã‚‹ã€**ã«ãªã‚‹ã¾ã§ã«ã‚„ã£ãŸã“ã¨ã‚’å¾Œã‹ã‚‰è¿½ãˆã‚‹ã‚ˆã†ã«ã‚ºãƒ©ã£ã¨æ›¸ãé€£ã­ãŸã‚‚ã®ã«ãªã‚Šã¾ã™ã€‚

ä½¿ç”¨ã™ã‚‹ã®ã¯åƒ•ã®å¤§å¥½ããªè¨€èª Elixir ã¨ãã® Web ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ Phoenix ã§ã™ã€‚ãŒã€**ã“ã®è¨˜äº‹ã§ã©ã®è¨€èªã‚’ç”¨ã„ã¦ã„ã‚‹ã‹ã¯é‡è¦ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚**
ï¼ˆè¨˜äº‹å†…ã§ Elixir ã®ã‚³ãƒ¼ãƒ‰ã¯ã»ã¼è§¦ã‚‰ãªã„ã§ã™ã—ï¼‰

ã¾ãŸã€Rails ãŒã‚ã‹ã‚‹æ–¹ã¯ä»¥ä¸‹ã®è¨˜äº‹ã§ Rails ã¨ Phoenix ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å¯¾å¿œã•ã›ã¦èª¬æ˜ã—ã¦ã„ã‚‹ã®ã§ãƒãƒ©è¦‹ã™ã‚‹ã¨ Phoenix ã§ä½•ã‚’ã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹ã‹ç†è§£ã§ãã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚
[RailsçµŒé¨“è€…ã«è´ˆã‚‹Phoenixå…¥é–€](/posts/2019-12-12-qiita-9cab44f508101e2866f5/)

ä½•ã‹è¨‚æ­£ã‚„è£œè¶³ã€ã‚¢ãƒ‰ãƒã‚¤ã‚¹ãªã©ã‚ã‚Šã¾ã—ãŸã‚‰ã€æ˜¯éæ˜¯éã‚³ãƒ¡ãƒ³ãƒˆã‹[Twitter](https://twitter.com/sanpo_shiho)ã¾ã§ãŠé¡˜ã„ã—ã¾ã™ï¼ğŸ™‡â€â™‚ï¸

## ã“ã®è¨˜äº‹ã§æ‰±ã†å†…å®¹
- Web ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ‰±ãˆã‚‹ç’°å¢ƒã‚’**Dockerfile**ã§ä½œæˆã™ã‚‹
- **docker-compose**ã‚’ä½¿ã£ã¦ Web ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ+DBï¼‰ã‚’å‹•ã‹ã™
- ä½œæˆã—ãŸ image ã‚’**dockerhub**ã«ä¸Šã’ã‚‹
- **Kubernetes(minikube)**ã‚’ä½¿ã£ã¦ Web ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ+DBï¼‰ã‚’å‹•ã‹ã™

## Dockerfileã®ä½œæˆ
ã§ã¯æ—©é€Ÿ Dockerfile ã‚’ä½œæˆã—ã¦ã„ãã¾ã™

Dockerfile ã§ã¯ã“ã‚Œã‹ã‚‰ä½œæˆã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠã§ä½•ã‚’ã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹ã‹ã‚’å®šç¾©ã—ã¾ã™ã€‚

ä»¥ä¸‹ã®å…¬å¼ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ãŒå‚è€ƒã«ãªã‚Šã¾ã™ã€‚
[Dockerfile ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹](http://docs.docker.jp/engine/reference/builder.html)

```dockerfile:Dockerfile
FROM elixir:1.10.2

RUN curl -sL https://deb.nodesource.com/setup_12.x | bash

RUN apt-get install -y nodejs

RUN npm install npm@latest -g

RUN mix local.hex --force

RUN mix archive.install hex phx_new 1.4.12 --force

RUN mix local.rebar --force

WORKDIR /app
```

### ã“ã®DockerfileãŒä½•ã‚’ã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹ã‹

åˆå¿ƒè€…ãªã‚Šã«ä¸€è¡Œãšã¤èª¬æ˜ã—ã¦ã¿ã¾ã™ã€‚

```dockerfile:
FROM elixir:1.10.2
```
è¦ªã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’é¸æŠã—ã¾ã™ã€‚
ã‚¤ãƒ¡ãƒ¼ã‚¸ã£ã¦ä½•ï¼Ÿã¨ã„ã†æ–¹ã¯ä»¥ä¸‹ã®å…¬å¼ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã®èª¬æ˜ãŒã‚ã‹ã‚Šã‚„ã™ã„ã§ã™
[Part 1ï¼šæ¦‚è¦èª¬æ˜ã¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— | ã‚³ãƒ³ãƒ†ãƒŠã®æ¦‚è¦ã‚’èª¬æ˜](http://docs.docker.jp/get-started/index.html#id11)

ã“ã®è¦ªã‚¤ãƒ¡ãƒ¼ã‚¸ã¯ Elixir å…¬å¼ã® image ã§ã™ã€‚

ã“ã†ã„ã£ãŸå…¬å¼ã§å‡ºã¦ã„ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ãªã©ã‹ã‚‰è‡ªåˆ†ã®ç›®çš„ã«å³ã—ãŸç’°å¢ƒãŒä½œã‚Œã‚‹ã‚ˆã†ã« `Dockerfile` ã‚’è¨˜è¿°ã—ã¦ã„ã£ã¦ã€ã‚«ã‚¹ã‚¿ãƒ ã—ã¦ã„ãè¨³ã§ã™ã€‚
ï¼ˆä»Šå›ã ã¨è‡ªåˆ†ã®ç›®çš„=Phoenix ã‚’å‹•ã‹ã›ã‚‹ç’°å¢ƒã¨ãªã‚Šã¾ã™ï¼‰

---------------------------------------

```dockerfile:
RUN curl -sL https://deb.nodesource.com/setup_12.x | bash

RUN apt-get install -y nodejs

RUN npm install npm@latest -g
```
nodejs ãŒå¿…è¦ãªã®ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ã¾ã™ã€‚

ã¡ãªã¿ã«ã¯ã˜ã‚ã¯ã“ã®éƒ¨åˆ†ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«è¨˜è¿°ã—ã¦ã„ãŸã®ã§ã™ãŒã€ï¼ˆnodejs ã« npm ã¯åŒæ¢±ã®ã¯ãšï¼‰
ã“ã†ã™ã‚‹ã¨ãã®å¾Œ `bash: npm: command not found` ãŒå‡ºã¦ã—ã¾ã„ã¾ã™ã€‚

ä»¥ä¸‹ã®ãƒšãƒ¼ã‚¸ã‚’å‚è€ƒã«ä¸Šã®ã‚³ãƒ¼ãƒ‰ã«è½ã¡ç€ãã¾ã—ãŸã€‚
[Dockerã§phpã‚³ãƒ³ãƒ†ãƒŠã¨ã‹ã«npmã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã¨ãã®ãƒ¡ãƒ¢](https://tsyama.hatenablog.com/entry/docker-not-found-npm)

```dockerfile:
RUN apt-get update \
    && apt-get install -y nodejs
```


---------------------------------------

```dockerfile:
RUN mix local.hex --force

RUN mix archive.install hex phx_new 1.4.12 --force

RUN mix local.rebar --force
```
hex ã¨ã„ã† Elixir ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†ãƒ„ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
ï¼ˆRuby ã§ã„ã† rubygemsï¼‰
ã“ã“ã§ `--force` ãŒã¤ã„ã¦ã‚‹ã®ã¯ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ãŸã‚ã§ã™

```
Shall I install Hex? (if running non-interactively, use "mix local.hex --force") [Yn] ** (Mix) Could not find an SCM for dependency :phx_new from Mix.Local.Installer.MixProject
```
é€”ä¸­ã§ yes ã¨ç­”ãˆãªã‘ã‚Œã°ã„ã‘ãªã„éƒ¨åˆ†ãŒã‚ã‚‹ã®ã§ã™ãŒã€ãã‚Œã‚’ `--force` ã‚’ã¤ã‘ã‚‹ã“ã¨ã§ç„¡è¦–ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã¾ã™ã€‚

## postgresã¯ã©ã†ã™ã‚“ã®ï¼Ÿ
ã¯ã„ã€å…ˆã»ã©ã® Dockerfile ã§ã¯ Elixir(Phoenix)ã®ç’°å¢ƒã—ã‹æ•´ã£ã¦ã„ã¾ã›ã‚“ã€‚
postgres ã®ã‚³ãƒ³ãƒ†ãƒŠã‚‚ä½œã‚‰ãªã‘ã‚Œã°ã„ã‘ãªã„ã§ã™ã€‚

ã—ã‹ã—
- postgres ã®ã‚³ãƒ³ãƒ†ãƒŠã¨ Phoenix ã®ã‚³ãƒ³ãƒ†ãƒŠé–“ã®é€šä¿¡ã¯ã©ã†ã™ã‚‹ã®ï¼Ÿ
- ã‚³ãƒ³ãƒ†ãƒŠé–“é€šä¿¡ã‚’é ‘å¼µã£ã¦è¨­å®šã—ãŸã¨ã—ã¦ã‚‚æ¯å›ãã‚Œã‚’è¨­å®šã™ã‚‹ã®ï¼Ÿ
- æ¯å› postgres ã®ã‚³ãƒ³ãƒ†ãƒŠã€Phoenix ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’ä¸¡æ–¹ç«‹ã¦ã‚‹ã®ã‚ã‚“ã©ãã›ãˆ

ã¨ã„ã†å•é¡ŒãŸã¡ãŒå‡ºã¦ãã¾ã™ã€‚
ã“ã‚Œã‚‰ã‚’è§£æ±ºã—ã¦ãã‚Œã‚‹ã®ãŒ**docker-compose**ã§ã™

â€»ã¡ãªã¿ã« `docker-compose` ã‚’ä½¿ã‚ãªã„ã‚³ãƒ³ãƒ†ãƒŠé–“é€šä¿¡ã¯ä»¥ä¸‹ã®ãƒšãƒ¼ã‚¸ã‚’å‚è€ƒã«ã™ã‚Œã°ã§ããã†ã§ã™ã€‚
https://kitsune.blog/docker-network#i

###ã€Œã„ã‚„ã„ã‚„åŒã˜ã‚³ãƒ³ãƒ†ãƒŠã« DB ã‚‚çªã£è¾¼ã‚ã°ãˆãˆã‚„ã‚“ï¼ã€ã«ã¤ã„ã¦
ãã†ãªã‚‹ã‹ã‚‚ã§ã™ãŒã€ã‚³ãƒ³ãƒ†ãƒŠã‚’åˆ†ã‘ã‚‹ã“ã¨ã«ã¯ã¡ã‚ƒã‚“ã¨ç†ç”±ãŒã‚ã‚Šã¾ã™ã€‚
ã“ã®å¾Œå‡ºã¦ãã‚‹ `docker-compose` ã¨ `Kubernetes` ã§ã¯ã‚¢ã‚¯ã‚»ã‚¹åˆ†æ•£ã®ãŸã‚ã«è¤‡æ•°ã®ã‚³ãƒ³ãƒ†ãƒŠã§ Web ã‚µãƒ¼ãƒãƒ¼ã‚’å‹•ã‹ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

åŒã˜ã‚³ãƒ³ãƒ†ãƒŠã« DB ã‚‚ä¸€ç·’ã«å…¥ã‚Œã¦ã—ã¾ã†ã¨ã€ã“ã®éš›ã« DB ã‚‚ãŸãã•ã‚“ã§ãã¦ã—ã¾ã„ã€**ã©ã®ã‚³ãƒ³ãƒ†ãƒŠã«æ¥ç¶šã•ã‚Œã‚‹ã‹ã§ DB ã®ä¸­èº«ãŒå¤‰ã‚ã£ã¦ã—ã¾ã†**ã¨è¨€ã†äº‹æ…‹ãŒèµ·ã“ã‚Šã¾ã™ã€‚
ã“ã‚Œã‚’é˜²ããŸã‚ã« DB ã¨ Web ã§ã‚³ãƒ³ãƒ†ãƒŠã‚’åˆ†ã‘ã¦ Web ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’å¢—ã‚„ã—ã¦ã‚‚åŒã˜ DB ã‚’å‚ç…§ã™ã‚‹ã‚ˆã†ã«è¨­å®šã™ã¹ããªè¨³ã§ã™

## docker-composeã‚’ä½¿ç”¨ã™ã‚‹
docker-compose ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã« `docker-compose.yml` ã‚’ä½œæˆã—ã¾ã™ã€‚
`docker-compose.yml`ã«ã¯ docker ã®ã‚³ãƒ³ãƒ†ãƒŠé”ã‚„ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«ã¤ã„ã¦ã‚ã‚‹ã¹ãå§¿ã‚’è¨˜è¿°ã—ã¾ã™ã€‚

ã™ã‚‹ã¨ docker-compose ãŒãã‚Œã‚’å…ƒã«è‰¯ã—ãªã«è¨­å®šã—ã¦ãã‚Œã‚‹ã‚ã‘ã§ã™ã€‚
ä»¥ä¸‹ã®ã‚ˆã†ã«ä½œæˆã—ã¾ã™ã€‚

```yml:docker-compose.yml
version: "3"  #docker-composeã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³æŒ‡å®š
services:     #ã“ã“ã‚ˆã‚Šä¸‹ã§serviceã‚’å®šç¾©
  web:
    build: .  #ä½¿ç”¨ã™ã‚‹Dockerfileã®å ´æ‰€
    ports:    #portã‚’ãƒã‚¤ãƒ³ãƒ‰
      - '4000:4000'
    volumes:  #hostã®./ã‚’/appã¨ã—ã¦å…±æœ‰
      - .:/app
    command: mix phx.server   #ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ã®ãŸã‚ã®ã‚³ãƒãƒ³ãƒ‰
    depends_on:
      - db    #webã®é–‹å§‹å‰ã«dbã‚’èµ·å‹•

  db:
    image: postgres  #ä½¿ç”¨ã™ã‚‹image
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_HOST=db
```

ä»¥ä¸‹ã®å…¬å¼ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ãŒã™ã”ãå‚è€ƒã«ãªã‚Šã¾ã™ã€‚
[Compose ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹](http://docs.docker.jp/compose/compose-file.html#network-configuration-reference)

docker-compose.yml ã«å®šç¾©ã—ãŸ `command` ã‚„ `ports` ã¯ `CMD` ã‚„ `EXPOSE` ã¨ã—ã¦ Dockerfile ã§å®šç¾©ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

ã“ã‚Œã§ Docker ã§ Elixir/Phoenix ã®ç’°å¢ƒã‚’ä½¿ç”¨ã™ã‚‹æº–å‚™ãŒã§ãã¾ã—ãŸã€‚

â€»volumes ã«é–¢ã—ã¦ã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…±æœ‰ã§ãã‚‹ã¨ã„ã†é¢ã¨ã€**ã‚³ãƒ³ãƒ†ãƒŠã®å¤–ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®‰å…¨ã«ç½®ã„ã¦ãŠã‘ã‚‹**ã¨ã„ã†é¢ã‚‚ã‚ã‚Šã¾ã™ã€‚è©³ã—ãã¯ Kubernetes ã®ç« ã§å‡ºã¦ãã¾ã™ã€‚

## é©å½“ãªã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã‚’ä½œã£ã¦ã¿ã‚‹
ãƒ†ã‚¹ãƒˆã‚‚ã‹ã­ã¦ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã‚’ä½œã£ã¦ã¿ã¾ã™ã€‚ï¼ˆã‚¢ãƒ—ãƒªåã¯ dododo ã«ã—ã¾ã—ãŸï¼‰

```bash:
$ docker-compose run web mix phx.new . --app dododo
Creating network "docker-elixir_default" with the default driver
Creating docker-elixir_db_1 ... done
The directory /app already exists. Are you sure you want to continue? [Yn] y
* creating config/config.exs
* creating config/dev.exs
* creating config/prod.exs
* creating config/prod.secret.exs
* creating config/test.exs
* creating lib/dododo/application.ex
* creating lib/dododo.ex
* creating lib/dododo_web/channels/user_socket.ex
* creating lib/dododo_web/views/error_helpers.ex
* creating lib/dododo_web/views/error_view.ex
* creating lib/dododo_web/endpoint.ex
* creating lib/dododo_web/router.ex
* creating lib/dododo_web.ex
* creating mix.exs
* creating README.md
* creating .formatter.exs
* creating .gitignore
* creating test/support/channel_case.ex
* creating test/support/conn_case.ex
* creating test/test_helper.exs
* creating test/dododo_web/views/error_view_test.exs
* creating lib/dododo/repo.ex
* creating priv/repo/migrations/.formatter.exs
* creating priv/repo/seeds.exs
* creating test/support/data_case.ex
* creating lib/dododo_web/controllers/page_controller.ex
* creating lib/dododo_web/templates/layout/app.html.eex
* creating lib/dododo_web/templates/page/index.html.eex
* creating lib/dododo_web/views/layout_view.ex
* creating lib/dododo_web/views/page_view.ex
* creating test/dododo_web/controllers/page_controller_test.exs
* creating test/dododo_web/views/layout_view_test.exs
* creating test/dododo_web/views/page_view_test.exs
* creating lib/dododo_web/gettext.ex
* creating priv/gettext/en/LC_MESSAGES/errors.po
* creating priv/gettext/errors.pot
* creating assets/webpack.config.js
* creating assets/.babelrc
* creating assets/js/app.js
* creating assets/js/socket.js
* creating assets/package.json
* creating assets/css/app.css
* creating assets/static/favicon.ico
* creating assets/css/phoenix.css
* creating assets/static/images/phoenix.png
* creating assets/static/robots.txt

Fetch and install dependencies? [Yn] y
* running mix deps.get
* running cd assets && npm install && node node_modules/webpack/bin/webpack.js --mode development
* running mix deps.compile

We are almost there! The following steps are missing:

    $ cd app

Then configure your database in config/dev.exs and run:

    $ mix ecto.create

Start your Phoenix app with:

    $ mix phx.server

You can also run your app inside IEx (Interactive Elixir) as:

    $ iex -S mix phx.server
```

ã¾ãŸã€ã—ã£ã‹ã‚Šãƒ›ã‚¹ãƒˆã¨ã®ãƒ•ã‚¡ã‚¤ãƒ«å…±æœ‰ã‚‚ã§ãã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

```bash:
$ ls
Dockerfile		_build			config			docker-compose.yml	mix.exs			priv
README.md		assets			deps			lib			mix.lock		test
```

## config/dev.exsã®å¾®ä¿®æ­£
`config/dev.exs`ã¯ dev ç’°å¢ƒã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚
ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ›ã‚¹ãƒˆåã‚’ db ã«å¤‰æ›´ã—ã¦ãŠãã¾ã™ã€‚

```config/dev.exs
# Configure your database
config :dododo, Dododo.Repo,
  username: "postgres",
  password: "postgres",
  database: "dododo_dev",
  hostname: "db",          #fix
  show_sensitive_data_on_connection_error: true,
  pool_size: 10
```

## DBã®ä½œæˆ
```bash:
$ docker-compose run web mix ecto.create
Starting docker-elixir_db_1 ... done
(çœç•¥)
Generated dododo app
The database for Dododo.Repo has been created
```

ã†ã¾ãä½œæˆã§ãã¾ã—ãŸã€‚
ã“ã‚Œã§ DB ã¨ã®é€£æºã‚‚ã†ã¾ãã„ã£ã¦ã„ã‚‹äº‹ãŒã‚ã‹ã‚Šã¾ã™ã€‚

## ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã‚’ç«‹ã¡ä¸Šã’ã¦ã¿ã‚‹
```bash:
$ docker-compose up
```

ä»¥ä¸‹ã®ã‚ˆã†ã«è¡¨ç¤ºã•ã‚Œã‚Œã°æˆåŠŸã§ã™ã€‚

![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2020-03-07 16.43.47.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/417600/8296ce70-b970-2c12-d76e-60ceb36a6984.png)

## dockerhubã«ã‚ã’ã‚‹

image ã‚’ç¢ºèªã—ã¦ tag ã‚’ã¤ã‘ã‚‹

```bash:
$ docker images
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
docker-elixir_web   latest              a9ff6e7b157f        29 minutes ago      1.37GB
<none>              <none>              507e3f91e80f        55 minutes ago      1.28GB
dododo_web          latest              d7724891c88c        4 hours ago         1.27GB
elixir              1.10.2              d6641893fb96        12 hours ago        1.23GB
postgres            latest              73119b8892f9        2 days ago          314MB

$ docker tag a9ff6e7b157f sanposhiho/phoenix:latest
```
 
dockerhub ã«ãƒ­ã‚°ã‚¤ãƒ³

```bash:
$ docker login
Login with your Docker ID to push and pull images from Docker Hub. If you don't have a Docker ID, head over to https://hub.docker.com to create one.
Username: sanposhiho
Password:
Login Succeeded
```

ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã‹ã‚‰é©å½“ã« `Create Repository` ã—ã¾ã™ã€‚
https://hub.docker.com/repository/create
![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2020-03-07 20.25.28.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/417600/f03d51e2-4569-1caf-521c-8e4e730fdc06.png)


ä½œã£ãŸ Repository ã« push ã—ã¾ã™ã€‚

```bash:
$ docker push  sanposhiho/phoenix
```

## dockerhubã«ã‚ã’ã‚‹ã¨ä½•ãŒã§ãã‚‹ã®ã‹
dockerhub ã«ã‚ã’ã‚‹äº‹ã§ Dockerfile ãŒå¿…è¦ãªããªã‚Šã¾ã™ã€‚

ã™ãªã‚ã¡**docker-compose.yml ã•ãˆã‚ã‚Œã°å…ˆã»ã©ã®ç’°å¢ƒãŒä½œæˆã§ãã‚‹**ã‚ã‘ã§ã™ã€‚

### docker-compose.ymlã‚’ä¿®æ­£
Dockerfile ã‚’ä½¿ç”¨ã—ãªã„å½¢ã« docker-compose.yml ã‚’ä¿®æ­£ã—ã¾ã™ã€‚

```docker-compose.yml
version: "3"
services:
  web:
    image: sanposhiho/phoenix  #å…ˆã»ã©ä½œæˆã—ãŸimage
    ports:
      - '4000:4000'
    volumes:
      - .:/app
    command: mix phx.server
    depends_on:
      - db

  db:
    image: postgres
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_HOST=db
```

å¤‰æ›´ç®‡æ‰€ã¯ web ã® image ã®éƒ¨åˆ†ã§ã™ã€‚
Dockerfile ã‚’å‚ç…§ã—ã¦ã„ãŸã®ã‚’å…ˆã»ã©ä½œæˆã—ãŸ image ã‚’æŒ‡å®šã—ã¾ã—ãŸã€‚

ã“ã‚Œã«ã‚ˆã‚Š sanposhiho/phoenix ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§å‰Šé™¤ã—ã¦ã‹ã‚‰ `docker-compose up` ã—ã¦ã‚‚

```
$ docker-compose up
Creating network "docker-elixir_default" with the default driver
Pulling db (postgres:)...
latest: Pulling from library/postgres
68ced04f60ab: Pull complete
59f4081d08e6: Pull complete
74fc17f00df0: Pull complete
8e5e30d57895: Pull complete
a1fd179b16c6: Pull complete
7496d9eb4150: Pull complete
0328931819fd: Pull complete
8acde85a664a: Pull complete
38e831e7d2d3: Pull complete
582b4ba3b134: Pull complete
cbf69ccc1db5: Pull complete
1e1f3255b2e0: Pull complete
c1c0cedd64ec: Pull complete
6adde56874ed: Pull complete
Digest: sha256:110d3325db02daa6e1541fdd37725fcbecb7d51411229d922562f208c51d35cc
Status: Downloaded newer image for postgres:latest
Pulling web (sanposhiho/phoenix:)...
latest: Pulling from sanposhiho/phoenix
50e431f79093: Already exists
dd8c6d374ea5: Already exists
c85513200d84: Already exists
55769680e827: Already exists
f5e195d50b88: Already exists
f7e2598a9cb7: Already exists
9ba52fdf113f: Already exists
896d0883eede: Already exists
019ae449ef4b: Already exists
a653e3c2dbc7: Pull complete
1b5116636524: Pull complete
6a7182c301e9: Pull complete
ff51ec8f406c: Pull complete
4c53f0b7d33e: Pull complete
79b95deb3b15: Pull complete
4e0c0135d3e7: Pull complete
Digest: sha256:ab7dbe3a514597f3e390f90de76de6465defb90103f58c3f08e34db97d890ae7
Status: Downloaded newer image for sanposhiho/phoenix:latest
Creating docker-elixir_db_1 ... done
Creating docker-elixir_web_1 ... done
```
ã“ã®ã‚ˆã†ã« sanposhiho/phoenix ãŒãªãã¦ã‚‚å‹æ‰‹ã« dockerhub ã‹ã‚‰å–ã£ã¦ãã¦ãã‚Œã¾ã™ã€‚

## Kubernetesã‚’ã‚„ã£ã¦ã„ã
ä»¥ä¸‹ã®è¨˜äº‹ã‚’å‚è€ƒã«å…ˆã»ã©ã®ç’°å¢ƒã‚’ Kubernetes(minikube)ã§ã‚‚å‹•ã‹ã—ã¦ã¿ã¾ã™ã€‚
[Docker Composeã‹ã‚‰Minikube + Komposeã«ç§»è¡Œã—ã¦ã¿ã‚ˆã†](https://qiita.com/progrhyme/items/116948c9fef37f3e995b#docker-compose%E8%A8%AD%E5%AE%9A%E3%82%92%E5%A4%89%E6%8F%9B%E3%81%99%E3%82%8B)

Kompose ã¨è¨€ã†ã®ã¯ `docker-compose.yml` ã‚’ Kubernetes å‘ã‘ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«å¤‰æ›ã—ã¦ãã‚Œã‚‹ä¾¿åˆ©ãªã‚„ã¤ã§ã™ã€‚

### ãã‚‚ãã‚‚Kubernetesã£ã¦ï¼Ÿ
è‰²ã€…è¦‹ã¾ã—ãŸãŒä»¥ä¸‹ã®è¨˜äº‹ã®å‰åŠéƒ¨åˆ†ã®èª¬æ˜ãŒã¨ã¦ã‚‚åˆ†ã‹ã‚Šæ˜“ã‹ã£ãŸã§ã™
[æ•°æ™‚é–“ã§å®Œå…¨ç†è§£ï¼ã‚ã‚Šã¨ã‚´ãƒ„ã„Kubernetesãƒãƒ³ã‚ºã‚ªãƒ³ï¼ï¼](https://qiita.com/Kta-M/items/ce475c0063d3d3f36d5d)

### Komposeã‚’ä½¿ã†å‰ã«è‰²ã€…ä¿®æ­£
#### Dockerfile
```dockerfile:Dockerfile
FROM elixir:1.10.2

RUN curl -sL https://deb.nodesource.com/setup_12.x | bash

RUN apt-get install -y nodejs

RUN npm install npm@latest -g

RUN mix local.hex --force

RUN mix archive.install hex phx_new 1.4.12 --force

RUN mix local.rebar --force

RUN apt-get install ca-certificates  #è¿½åŠ 

COPY . /app                          #è¿½åŠ 

WORKDIR /app
```
ã“ã‚Œã‚’å…ˆã»ã©ã®æ‰‹é †ã§ dockerhub ã«ä¸Šã’ã¾ã™
(åƒ•ã¯ sanposhiho/phoenix_for_k8s ã¨ã—ã¦ä¸Šã’ã¾ã—ãŸã€‚)

#### docker-compose.yml
```yml:docker-compose.yml
version: "3"
services:
  web:
    image: sanposhiho/phoenix_for_k8s  #å¤‰æ›´
    ports:
      - '4000:4000'
    command: mix phx.server
    depends_on:
      - db

  db:
    image: postgres
    ports:
        - "5432:5432"  #è¿½åŠ 
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_HOST=db
```
è¿½åŠ /å¤‰æ›´ã®ä»–ã« volume ã®éƒ¨åˆ†ãŒå‰Šé™¤ã•ã‚Œã¦ã„ã¾ã™ã€‚

### komposeã§å¤‰æ›

```bash:
$ kompose convert
INFO Kubernetes file "db-service.yaml" created
INFO Kubernetes file "web-service.yaml" created
INFO Kubernetes file "db-deployment.yaml" created
INFO Kubernetes file "web-deployment.yaml" created
```
å¹¾ã¤ã‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã¾ã—ãŸã€‚

### ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¾®ä¿®æ­£
`web-service.yaml`ã«ä»¥ä¸‹ã‚’è¿½è¨˜ã—ã¾ã™ã€‚

```yml:web-servise.yaml
apiVersion: v1
kind: Service
metadata:
  annotations:
    kompose.cmd: kompose convert
    kompose.version: 1.21.0 ()
  creationTimestamp: null
  labels:
    io.kompose.service: web
  name: web
spec:
  ports:
  - name: "4000"
    port: 4000
    targetPort: 4000
  selector:
    io.kompose.service: web
  type: NodePort              #è¿½åŠ 
status:
  loadBalancer: {}
```

ã“ã‚Œã«ã‚ˆã‚Šå¤–ã®ä¸–ç•Œã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

### ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¦‹ã¦ã„ã
Kompose ãŒç”Ÿæˆã—ã¦ãã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚
ä»¥ä¸‹ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒç†è§£ã®ä¸Šã§å½¹ç«‹ã¤ã¨æ€ã„ã¾ã™ã€‚
[Kubernetes | Kubernetesã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç†è§£ã™ã‚‹](https://kubernetes.io/ja/docs/concepts/overview/working-with-objects/kubernetes-objects/)

Kompose ã«ã‚ˆã£ã¦å¤§ããåˆ†ã‘ã¦ã€ŒDeploymentã€ã¨ã€ŒServiceã€ã® 2 ã¤ãŒä½œæˆã•ã‚Œã¦ã„ã¾ã™ã€‚

#### Deploymentã¨ã¯
Deployment ã«é–¢ã—ã¦ã¯ä»¥ä¸‹ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒã‚ã‹ã‚Šã‚„ã™ã„ã§ã™ã€‚
[Kubernetes  | Deployment](https://kubernetes.io/ja/docs/concepts/workloads/controllers/deployment/)

ä»¥ä¸‹ã®è¨˜äº‹ã‚‚ï¼ˆå°‘ã—å¤ã„ã§ã™ãŒï¼‰ã¨ã¦ã‚‚å‚è€ƒã«ãªã‚Šã¾ã—ãŸã€‚
[Kubernetes: Deployment ã®ä»•çµ„ã¿](https://qiita.com/tkusumi/items/01cd18c59b742eebdc6a)

deployment ã¯ pod(Kubernetes ã®ç®¡ç†ã™ã‚‹æœ€å°å˜ä½)ã‚’ç®¡ç†ã—ã¾ã™ã€‚
ï¼ˆæ­£ç¢ºã«ã¯ pod ã‚’ç®¡ç†ã™ã‚‹ ReplicaSet ã‚’ä½œæˆã—ã¾ã™ã€‚ï¼‰

å®Ÿéš›ã«ä½œæˆã•ã‚ŒãŸ `web-deployment.yaml` ã‚’è¦‹ã¦ã¿ã¾ã™ã€‚

```yml:web-deployment.yaml
apiVersion: apps/v1                #ã©ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®KubernetesAPIã‚’åˆ©ç”¨ã™ã‚‹ã‹
kind: Deployment                   #ä½•ã«ã¤ã„ã¦ã®å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ã‹
metadata:
  annotations:
    kompose.cmd: kompose convert
    kompose.version: 1.21.0 ()
  creationTimestamp: null
  labels:
    io.kompose.service: web
  name: web                         #deploymentã®åå‰
spec:
  replicas: 1                       #replicaã®æ•°
  selector:
    matchLabels:
      io.kompose.service: web       #podã®ãƒ©ãƒ™ãƒ«å®šç¾©
  strategy: {}
  template:                         #deploymentãŒç®¡ç†ã™ã‚‹podã®å®šç¾©
    metadata:
      annotations:
        kompose.cmd: kompose convert
        kompose.version: 1.21.0 ()
      creationTimestamp: null
      labels:
        io.kompose.service: web
    spec:
      containers:
      - args:
        - mix
        - phx.server
        image: sanposhiho/phoenix_for_k8s
        imagePullPolicy: ""
        name: web
        ports:
        - containerPort: 4000
        resources: {}
      restartPolicy: Always
      serviceAccountName: ""
      volumes: null
status: {}
```

`web-deployment.yaml`ã§ã¯ `spec.template` ã§æŒ‡å®šã•ã‚ŒãŸ pod ã‚’å¸¸ã« 1 ã¤ç¶­æŒã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

#### Serviceã¨ã¯
ä»¥ä¸‹ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå‚è€ƒã«ãªã‚Šã¾ã™ã€‚
[Kubernetes | Service](https://kubernetes.io/ja/docs/concepts/services-networking/service/)

Pod ã¯ãã‚Œãã‚ŒãŒ IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŒã£ã¦ã„ã¾ã™ã€‚ä¾‹ãˆã°ä»Šå›ã®ã‚ˆã†ã« DB ã® Pod ã¨ Web ã‚µãƒ¼ãƒãƒ¼ã® Pod ã«åˆ¥ã‚Œã¦ã„ã‚‹å ´åˆã€Web ã‚µãƒ¼ãƒãƒ¼ãŒ DB ã® Pod ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã«ã¯ DB ã® Pod ã® IP ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚

ãã“ã§ `Service` ã¯ pod ãŸã¡ã‚’ã‚»ãƒƒãƒˆã§ç®¡ç†ã—ï¼ˆã€ŒDB ã® Podã€ã€Œã‚µãƒ¼ãƒãƒ¼ã® Podã€ã¨è¨€ã†é¢¨ã«ç®¡ç†ï¼‰ã€ãã®ã‚»ãƒƒãƒˆã«å¯¾ã—ã¦ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚
ä¾‹ãˆ Pod ãŒå‹•çš„ã«å…¥ã‚Œæ›¿ã‚ã£ãŸã‚Šã—ã¦ã‚‚ä¸€è²«ã—ãŸæ–¹æ³•ã§ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚
ï¼ˆ`Service`ç„¡ã—ã ã¨ã€ä½•ã‹ã®éšœå®³ã§ 1 ã¤ã® Pod ãŒæ­»ã‚“ã§ã€Deployment ãŒä»£ã‚ã‚Šã® Pod ã«å…¥ã‚Œæ›¿ãˆãŸæ™‚ã«ã¯ IP ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå¤‰ã‚ã£ã¦ã—ã¾ã†ã®ã§ã‚¢ã‚¯ã‚»ã‚¹ãŒã§ããªããªã£ã¦ã—ã¾ã„ã¾ã™ï¼‰

å®Ÿéš›ã«ä½œæˆã•ã‚ŒãŸ `web-service.yaml` ã‚’ã¿ã¦ã¿ã¾ã™ã€‚

```web-service.yaml
apiVersion: v1
kind: Service
metadata:
  annotations:
    kompose.cmd: kompose convert
    kompose.version: 1.21.0 ()
  creationTimestamp: null
  labels:
    io.kompose.service: web
  name: web
spec:
  ports:                      #ç®¡ç†ã™ã‚‹portã«é–¢ã—ã¦
  - name: "4000"       
    port: 4000
    targetPort: 4000
  selector:                   #ç®¡ç†ã™ã‚‹Podã®æŒ‡å®š
    io.kompose.service: web
  type: NodePort
status:
  loadBalancer: {}
```
å…ˆã»ã©è¿½åŠ ã—ãŸ `type: NodePort` ã¯æŒ‡å®šã—ãªã‹ã£ãŸå ´åˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¨ã—ã¦ `ClusterIP` ã«æŒ‡å®šã•ã‚Œã¾ã™ã€‚
>ClusterIP:
ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…éƒ¨ã®IPã§Serviceã‚’å…¬é–‹ã™ã‚‹ã€‚ã“ã®ã‚¿ã‚¤ãƒ—ã§ã¯Serviceã¯ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…éƒ¨ã‹ã‚‰ã®ã¿ç–é€šæ€§ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã‚Œã§ã¯ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®å¤–éƒ¨ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒã§ããªã‹ã£ãŸãŸã‚ `NodePort` ã«å¤‰æ›´ã—ã¾ã—ãŸ
>NodePort:
å„Nodeã®IPã«ã¦ã€é™çš„ãªãƒãƒ¼ãƒˆ(NodePort)ä¸Šã§Serviceã‚’å…¬é–‹ã—ã¾ã™ã€‚ãã®NodePort ã®ServiceãŒè»¢é€ã™ã‚‹å…ˆã®ClusterIP ServiceãŒè‡ªå‹•çš„ã«ä½œæˆã•ã‚Œã¾ã™ã€‚<NodeIP>:<NodePort>ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦NodePort Serviceã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

[Serviceã®å…¬é–‹ (Serviceã®ã‚¿ã‚¤ãƒ—)](https://kubernetes.io/ja/docs/concepts/services-networking/service/#publishing-services-service-types)

### minikubeã‚’ç«‹ã¡ä¸Šã’ã¦ãŠã
```bash:
$ minikube start
```

### ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’é–‹ã„ã¦ãŠã

```bash:
$ minikube dashboard 
```
ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’ä½¿ãˆã°ä»¥ä¸‹ã®ã‚ˆã†ã« Pod ãªã©ã®çŠ¶æ…‹ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ç¢ºèªã§ãã¾ã™ã€‚
![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2020-03-08 18.22.25.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/417600/da727365-f12d-3c17-f89f-4c206a86bf84.png)

### ç«‹ã¡ä¸Šã’ï¼
ã¤ã„ã« Kubernetes ä¸Šã§ç«‹ã¡ä¸Šã’ã¦ã¿ã¾ã™ã€‚

```bash:
$ kubectl apply -f db-deployment.yaml
$ kubectl apply -f web-deployment.yaml
$ kubectl apply -f db-service.yaml
$ kubectl apply -f web-service.yaml
```
ã“ã‚Œã«ã‚ˆã£ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã«å®šç¾©ã•ã‚ŒãŸã‚‚ã®é”ãŒç«‹ã¡ä¸ŠãŒã‚Šã¾ã™ã€‚

```bash:
kensei-mba:docker-elixir nakatakensei$ kubectl get all
NAME                      READY   STATUS    RESTARTS   AGE
pod/db-5fbcf655cd-2k7lw   1/1     Running   0          159m
pod/web-87795996-r6rcf    1/1     Running   0          159m


NAME                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
service/db           ClusterIP   10.111.98.119   <none>        5432/TCP         159m
service/kubernetes   ClusterIP   10.96.0.1       <none>        443/TCP          19h
service/web          NodePort    10.107.156.58   <none>        4000:30249/TCP   159m


NAME                  READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/db    1/1     1            1           159m
deployment.apps/web   1/1     1            1           159m

NAME                            DESIRED   CURRENT   READY   AGE
replicaset.apps/db-5fbcf655cd   1         1         1       159m
replicaset.apps/web-87795996    1         1         1       159m
```

### DBã‚’ä½œæˆã™ã‚‹

```bash:
kubectl exec -it web-87795996-r6rcf mix ecto.create
```

`kubectl exec -it <Pod NAME> <command>`ã§ä»»æ„ã®ã‚³ãƒ¼ãƒ‰ã‚’ Pod ã«å¯¾ã—ã¦å®Ÿè¡Œã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ã¾ãŸã€ã“ã®ã‚³ãƒ¼ãƒ‰ãŒé€šã‚‹=Service ãŒæ©Ÿèƒ½ã—ã¦ DB ã«ç¹‹ã„ã§ãã‚Œã¦ã„ã‚‹ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚

### ã¡ã‚ƒã‚“ã¨ç«‹ã¡ä¸ŠãŒã£ã¦ã„ã‚‹ã‹ç¢ºèª

```bash:
$ minikube service list
|----------------------|---------------------------|--------------|---------------------------|
|      NAMESPACE       |           NAME            | TARGET PORT  |            URL            |
|----------------------|---------------------------|--------------|---------------------------|
| default              | db                        | No node port |
| default              | kubernetes                | No node port |
| default              | web                       |              | http://192.168.64.2:32566 |
| kube-system          | kube-dns                  | No node port |
| kubernetes-dashboard | dashboard-metrics-scraper | No node port |
| kubernetes-dashboard | kubernetes-dashboard      | No node port |
|----------------------|---------------------------|--------------|---------------------------|
```
web ã® URL ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™
![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2020-03-08 15.52.53.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/417600/6cd4f371-8740-8d94-5a66-349bd3889050.png)
ã“ã®ã‚ˆã†ã« Phoenix ã® Top ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚Œã°æˆåŠŸã§ã™ï¼

### ã“ã‚Œã§ã‚‚å‹•ã„ã¦ã¯ã„ã¾ã™ãŒâ€¦
ç¾çŠ¶ã®è¨­å®šã§ã¯ DB ã® Pod å†…ã®ã¿ã« DB ã®ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã™ã€‚
ãªã®ã§ DB ã® Pod ãŒæ­»ã‚“ã æ™‚ã«å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒæ­»ã‚“ã§ã—ã¾ã„ã¾ã™ã€‚

1 å›å®Ÿé¨“ã—ã¦ã¿ã¾ã—ã‚‡ã†

![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2020-03-08 20.12.00.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/417600/b6a6e557-d153-fd85-8231-9dfcae153a1c.png)

ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰ä½œæˆã•ã‚Œã¦ã„ã‚‹**Kubernetes ä»¥å¤–ã®**Service, Pod, deployment ã‚’å…¨ã¦å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚

ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Œã°åˆã£ã¦ã„ã¾ã™ã€‚
![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2020-03-08 20.05.10.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/417600/70c18357-2dd3-524d-03bc-9324ba9c4683.png)


### Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’DBã‚’ä½¿ã†ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ä½œã‚Šç›´ã™
Phoenix ã«ã‚‚ Rails ã¨åŒæ§˜ã«ä¾¿åˆ©ãª generator ã®æ©Ÿèƒ½ãŒæ­è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚

ãƒ­ãƒ¼ã‚«ãƒ«ã§ generator ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```bash:
$ mix phx.gen.html Blog Post posts title:string content:string
* creating lib/dododo_web/controllers/post_controller.ex
* creating lib/dododo_web/templates/post/edit.html.eex
* creating lib/dododo_web/templates/post/form.html.eex
* creating lib/dododo_web/templates/post/index.html.eex
* creating lib/dododo_web/templates/post/new.html.eex
* creating lib/dododo_web/templates/post/show.html.eex
* creating lib/dododo_web/views/post_view.ex
* creating test/dododo_web/controllers/post_controller_test.exs
* creating lib/dododo/blog/post.ex
* creating priv/repo/migrations/20200308110013_create_posts.exs
* creating lib/dododo/blog.ex
* injecting lib/dododo/blog.ex
* creating test/dododo/blog_test.exs
* injecting test/dododo/blog_test.exs

Add the resource to your browser scope in lib/dododo_web/router.ex:

    resources "/posts", PostController


Remember to update your repository by running migrations:

    $ mix ecto.migrate

```
æ›¸ã‹ã‚Œã¦ã„ã‚‹ã‚ˆã†ã« `router.ex` ã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’è¿½åŠ ã—ã¦ãŠãã¾ã™ã€‚


```lib/dododo_web/router.ex
defmodule DododoWeb.Router do
  use DododoWeb, :router

  pipeline :browser do
    plug :accepts, ["html"]
    plug :fetch_session
    plug :fetch_flash
    plug :protect_from_forgery
    plug :put_secure_browser_headers
  end

  pipeline :api do
    plug :accepts, ["json"]
  end

  scope "/", DododoWeb do
    pipe_through :browser

    get "/", PageController, :index
    resources "/posts", PostController   #è¿½åŠ 
  end

  # Other scopes may use custom stacks.
  # scope "/api", DododoWeb do
  #   pipe_through :api
  # end
end
```

migration ã—ã¾ã™

```bash:
$ mix ecto.migrate

11:23:37.327 [info]  == Running 20200308110013 Dododo.Repo.Migrations.CreatePosts.change/0 forward

11:23:37.335 [info]  create table posts

11:23:37.392 [info]  == Migrated 20200308110013 in 0.0s
```

ã“ã‚Œã§ `/posts` ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¢ãƒ—ãƒªãŒä½œæˆã§ãã¦ã„ã¾ã™
ï¼ˆç”»åƒã¯ New Post ã‹ã‚‰æ–°ãŸãª post ã‚’ä½œæˆã—ãŸå¾Œã§ã™ï¼‰
![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2020-03-08 20.29.24.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/417600/77c4e9ce-cd70-3fbf-6a56-127c17fae5c7.png)

ã“ã®å¤‰æ›´ã‚’ dockerhub ã® image ã«åæ˜ ã•ã›ã¾ã™ã€‚
å…ˆã»ã©èª¬æ˜ã—ãŸæ‰‹é †ã¨ã»ã¨ã‚“ã©åŒã˜ãªã®ã§ã‚³ãƒãƒ³ãƒ‰ã ã‘è¼‰ã›ã¦ãŠãã¾ã™ã€‚

```bash:
$ docker build .
$ docker images   #image idã‚’å–å¾—
$ docker tag <image id> sanposhiho/phoenix_for_k8s
$ docker push sanposhiho/phoenix_for_k8s
```

### minikubeç’°å¢ƒã§å¤‰æ›´å¾Œã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‹•ã‹ã™
ã“ã¡ã‚‰ã‚‚ã»ã¼æ‰‹é †ãŒå¤‰ã‚ã‚‰ãªã„ã®ã§ã‚³ãƒãƒ³ãƒ‰ã ã‘è¼‰ã›ã¦ãŠãã¾ã™ã€‚

```bash:
$ kubectl apply -f db-deployment.yaml
$ kubectl apply -f web-deployment.yaml
$ kubectl apply -f db-service.yaml
$ kubectl apply -f web-service.yaml
$ kubectl get pods   #pod nameã®ç¢ºèª
$ kubectl exec -it <Pod NAME> mix ecto.create
$ kubectl exec -it <Pod NAME> mix ecto.migrate
```

å…ˆã»ã©ã¨é•ã†ã®ã¯æœ€å¾Œã« `$ kubectl exec -it <Pod NAME> mix ecto.migrate` ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã§ã™ã€‚ã“ã‚Œã«ã‚ˆã£ã¦ posts ãƒ†ãƒ¼ãƒ–ãƒ«ãŒ DB ã® Pod å†…ã«ä½œæˆã•ã‚Œã¾ã™ã€‚

ç”»åƒä½¿ã„å›ã—ã§ã™ãŒã€ä»¥ä¸‹ã®ãƒšãƒ¼ã‚¸ãŒ/posts ã‹ã‚‰ç¢ºèªã§ãã‚Œã°æˆåŠŸã§ã™ã€‚

![hoge.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/417600/e781a5df-3fa3-cb9b-d420-9acb0f69d1a0.png)


### DBã®Podã‚’å‰Šé™¤ã—ã¦ã¿ã‚‹
ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰ DB ã® Pod ã‚’å‰Šé™¤ã—ã¾ã™ã€‚
![eee.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/417600/bdf5221a-1f9f-ad9d-9e1f-8d2ab8c4267a.png)


Deployment ã«ã‚ˆã£ã¦ã™ãã«æ–°ã—ã„ DB ç”¨ã® Pod ãŒä½œã‚‰ã‚Œã¾ã™ã€‚ï¼ˆã•ã™ãŒï¼‰

ã•ã¦ã€å…ˆã»ã©ã®ãƒšãƒ¼ã‚¸ã‚’é–‹ãç›´ã—ã¦ã¿ã‚‹ã¨ã©ã†ãªã£ã¦ã„ã‚‹ã§ã—ã‚‡ã†ã‹
![qqqqq.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/417600/28ec8d87-d848-37ea-1c4a-8488d6bcc56b.png)

è¨³ã®ã‚ã‹ã‚‰ã‚“ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã„ã¾ã™ã€‚
ã€Œä½•å›ã‹ DB ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã‚ˆã†ã¨ã—ãŸã‘ã©ã€ç„¡ç†ã§ã—ãŸãƒ¼ã€ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ã§ã™ã€‚

ç„¡äº‹ã«(?)DB ãŒ Pod ãŒæ­»ã‚“ã ã“ã¨ã§æ¶ˆãˆã¦ã—ã¾ã£ãŸã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚

ã¡ãªã¿ã«ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ DB ã‚’ä½œã‚Šç›´ã—ã¦ Posts ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å†ä½œæˆã™ã‚‹ã¨å…ˆã»ã©ã®ã€Œã»ã’ã»ã’ã€ã®ãƒ‡ãƒ¼ã‚¿ã¯æ®‹ã£ã¦ã„ã¾ã›ã‚“ãŒã€ãƒšãƒ¼ã‚¸ãŒæ­£å¸¸ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
(ä½œã‚Šç›´ã•ã‚ŒãŸ DB ã® Pod ã«æ–°ã—ãå‡ºæ¥ãŸ DB ã ã‹ã‚‰å½“ãŸã‚Šå‰ã§ã™ã­)

```bash:
$ kubectl get pods   #pod nameã®ç¢ºèª
$ kubectl exec -it <Pod NAME> mix ecto.create
$ kubectl exec -it <Pod NAME> mix ecto.migrate
```

![hoge.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/417600/84996198-c8f6-a282-d6f5-514a6e721a07.png)


### volumeã‚’è¨­å®šã—ã¦DBã®æ®ç™ºã‚’é˜²ã
é•·ã€…å®Ÿé¨“ã—ã¾ã—ãŸãŒã€ã“ã® DB ã®æ®ç™ºï¼ˆ=æ°¸ç¶šã®é€†ã€‚Pod ãŒæ­»ã¬ã¨ DB ã‚‚ä¸€ç·’ã«æ¶ˆãˆã¦ã—ã¾ã†ã¨è¨€ã†æ„ï¼‰ã‚’é˜²ãã«ã¯ volume ã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

volume ã®è¨­å®šæ–¹æ³•ã§ã™ãŒ 2 ã¤å­˜åœ¨ã—ã¾ã—ãŸã€‚
ï¼ˆã©ã£ã¡ãŒã„ã„ã®ã‹ã¯åˆ†ã‹ã‚‰ãªã„ã§ã™â€¦ã©ãªãŸã‹æ•™ãˆã¦ãã ã•ã„ã€‚ï¼‰

1. `db-development.yaml`ã® volumes ã®ã¿ã‚’å¼„ã‚‹
2. `PersistentVolumeClaim`ã‚’åˆ©ç”¨ã™ã‚‹

### 1. `db-development.yaml`ã®volumesã®ã¿ã‚’å¼„ã‚‹

```db-development.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  annotations:
    kompose.cmd: kompose convert
    kompose.version: 1.21.0 ()
  creationTimestamp: null
  labels:
    io.kompose.service: db
  name: db
spec:
  replicas: 1
  selector:
    matchLabels:
      io.kompose.service: db
  strategy: {}
  template:
    metadata:
      annotations:
        kompose.cmd: kompose convert
        kompose.version: 1.21.0 ()
      creationTimestamp: null
      labels:
        io.kompose.service: db
    spec:
      containers:
      - env:
        - name: POSTGRES_HOST
          value: db
        - name: POSTGRES_PASSWORD
          value: postgres
        - name: POSTGRES_USER
          value: postgres
        image: postgres
        imagePullPolicy: ""
        name: db
        ports:
        - containerPort: 5432
        volumeMounts:                     #è¿½åŠ 
          - mountPath: "/var/lib/postgresql/data"
            name: pgdata
        resources: {}
      restartPolicy: Always
      serviceAccountName: ""
      volumes:                  ã€€ã€€ã€€    #è¿½åŠ 
        - name: pgdata
          hostPath:
            path: /Users/nakatakensei/docker-elixir/  #postgresã®dataã‚’hostã®ã©ã“ã«ç½®ã„ã¦ãŠãã‹

```

### 2. `PersistentVolumeClaim`ã‚’åˆ©ç”¨ã™ã‚‹

```pvc-phoenix.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pv-claim
spec:
  storageClassName: standard
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
```

```db-development.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  annotations:
    kompose.cmd: kompose convert
    kompose.version: 1.21.0 ()
  creationTimestamp: null
  labels:
    io.kompose.service: db
  name: db
spec:
  replicas: 1
  selector:
    matchLabels:
      io.kompose.service: db
  strategy: {}
  template:
    metadata:
      annotations:
        kompose.cmd: kompose convert
        kompose.version: 1.21.0 ()
      creationTimestamp: null
      labels:
        io.kompose.service: db
    spec:
      containers:
      - env:
        - name: POSTGRES_HOST
          value: db
        - name: POSTGRES_PASSWORD
          value: postgres
        - name: POSTGRES_USER
          value: postgres
        image: postgres
        imagePullPolicy: ""
        name: db
        ports:
        - containerPort: 5432
        volumeMounts:
          - mountPath: "/var/lib/postgresql/data"
            name: pgdata
        resources: {}
      restartPolicy: Always
      serviceAccountName: ""
      volumes:
        - name: pgdata
          persistentVolumeClaim:   #1ã¨ã¯ã“ã“ãŒé•ã†
            claimName: pv-claim
```

å…ˆã»ã©ã®æ‰‹é †ã§å®Ÿé¨“ã—ã¦ã‚‚ã‚‰ã†ã¨ã©ã¡ã‚‰ã®æ–¹æ³•ã‚’ç”¨ã„ã¦ã‚‚ DB æ®ç™ºã—ã¡ã‚ƒã†å•é¡ŒãŒè§£æ±ºã—ãŸã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚
ï¼ˆã‚¹ã‚¯ã‚·ãƒ§ã‚’æ’®ã£ã¦ã‚‚åˆ†ã‹ã‚Šé›£ã‹ã£ãŸãŸã‚ã€ã“ã“ã¾ã§å®Ÿéš›ã«æ‰‹ã‚’å‹•ã‹ã—ã¦é€²ã‚ã¦ã„ãŸã ã„ãŸæ–¹ã¯è‡ªåˆ†ã§å®Ÿé¨“ã—ã¦ã¿ã¦ãã ã•ã„ï¼‰

## çµ‚ã‚ã‚Šã«

æœ€çµ‚çš„ãªãƒ•ã‚¡ã‚¤ãƒ«é”ã¯ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã«ä¸ŠãŒã£ã¦ã„ã¾ã™ã€‚
https://github.com/sanposhiho/docker-elixir-phoenix

ã™ã”ãé•·ã„è¨˜äº‹ã«ãªã£ã¦ã—ã¾ã„ã¾ã—ãŸã€‚
ã—ã‹ã—ã€å€‹äººçš„ã« Dockerâ†’Kubernetes ã¨ä¸€ç·’ã®æµã‚Œã§å­¦ã¹ã‚‹ã‚ˆã†ãªãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãŒç„¡ã‹ã£ãŸãŸã‚è¨˜äº‹ã‚’åˆ†ã‘ãšã«ã“ã®ã‚ˆã†ã«é€²ã‚ã¾ã—ãŸã€‚

ã©ãªãŸã‹ã®å½¹ã«ç«‹ã¦ã°å¹¸ã„ã§ã™ã€‚

## å‚è€ƒ
è¨˜äº‹å†…ã§ã‚ã’ãªã‹ã£ãŸã‘ã©ãƒãƒ©ãƒãƒ©è¦‹ã¦å‚è€ƒã«ã•ã›ã¦ã„ãŸã ã„ãŸã‚µã‚¤ãƒˆã§ã™ã€‚

[Dockerã§Ruby on Railsã®é–‹ç™ºã‚’ã—ã‚ˆã†](https://qiita.com/saitoeku3/items/b1aa2ae143624e551aea)
[kubernetesã‚¯ãƒ©ã‚¹ã‚¿ã§Railsã‚¢ãƒ—ãƒªã‚’å…¬é–‹ã™ã‚‹ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«](https://qiita.com/tatsurou313/items/223dfa599ee5aaf6b2f0)
[Kubernetesã®æ°¸ç¶šåŒ– [PersistentVolume/PersistentVolumeClaim]](https://noumenon-th.net/programming/2019/04/19/persistentvolume/)

